<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Pupilla">
<title>Pupilla::TOBII::Complete pipeline • Pupilla</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Pupilla::TOBII::Complete pipeline">
<meta property="og:description" content="Pupilla">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">Pupilla</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/Pupilla.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Pupilla_Eyelink_SingleSubjectPreprocessing.html">Pupilla::EyeLink::Read and preprocessing</a>
    <a class="dropdown-item" href="../articles/Pupilla_TOBII_ReduceFeatures.html">Pupilla::TOBII::Complete pipeline</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/EBlini/Pupilla/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Pupilla::TOBII::Complete pipeline</h1>
                        <h4 data-toc-skip class="author">Elvio
Blini</h4>
            
            <h4 data-toc-skip class="date">January 2024</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/EBlini/Pupilla/blob/HEAD/vignettes/Pupilla_TOBII_ReduceFeatures.Rmd" class="external-link"><code>vignettes/Pupilla_TOBII_ReduceFeatures.Rmd</code></a></small>
      <div class="d-none name"><code>Pupilla_TOBII_ReduceFeatures.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>Pupilla</code> gathers several functions that are designed to
facilitate the analysis of pupillometry experiments as commonly
performed in cognitive neuroscience, e.g. event-related designs,
although its use could be much more general.</p>
<p>The typical analysis pipeline would, coarsely, include the following
steps:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Read the data.</strong> This part can vary a lot
depending on the eyetracker used, the individual OS, local paths, how
the experiment was coded, etc. <code>Pupilla</code> does provide utility
functions to read from common eyetrackers (e.g., TOBII, EyeLink) but
clearly this passage will need to be tailored to your files.</p></li>
<li><p><strong>Prepare the data.</strong> As above, this part may need
to be tailored to your specific needs; however, several steps are very
common across pipelines, and will be presented in this
vignette.</p></li>
<li><p><strong>Preprocessing.</strong> Pupillometry needs robust
preprocessing of the raw data, in order to reduce noise and artifacts
(such as those due to blinks). Once the data is properly prepared, this
aspect can be translated across several different scenarios. Of course,
flexibility and adapting to your own data is warmly advised.</p></li>
<li><p><strong>Statistical modelling</strong>. <code>Pupilla</code>
offers two approaches: 1) crossvalidated LMEMs as in <a href="https://link.springer.com/article/10.3758/s13428-022-01957-7" class="external-link">Mathôt
&amp; Vilotijević, 2022</a>); and 2) an original approach through
feature reduction. This vignette covers and illustrates the second
option.</p></li>
</ol>
<p>For this example we use data from <a href="https://link.springer.com/article/10.3758/s13423-022-02192-z" class="external-link">Blini
and Zorzi, 2023</a>. Data can be retrieved from the associated <a href="https://osf.io/6r5ch/" class="external-link">OSF repository</a>. The eyetracker used was
the TOBII spectrum. Unfortunately, the eyetracking data acquired this
way are quite large, meaning that reading them will take some time. In
this study (termed <strong>Passive Viewing (PV) task</strong>) 40
participants (following exclusions), of which 20 smokers and 20 non
smokers, were given, as the name suggests, several images to look at:
some were related to nicotine, and some were neutral controls. Contrary
to what the name suggest, instead, they also had to report (hence
somehow actively) the occurrence of a rare probe, which was presented on
screen very sparingly; this was to ensure central fixation was
maintained together with a minimum of task engagement. Details are
provided in the accompanying paper, what matters here is that smokers
were found to have pupillary <strong>constriction</strong> when
nicotine-related images (as opposed to neutral ones) were presented.
Please note that the pipeline and the default parameters in
<code>Pupilla</code> have changed since that paper came out in PBR, so
that results will be slightly different.</p>
</div>
<div class="section level2">
<h2 id="read-the-data">Read the data<a class="anchor" aria-label="anchor" href="#read-the-data"></a>
</h2>
<p>The library <code>Pupilla</code> must be installed first, and only
once, through <code>devtools</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"EBlini/Pupilla"</span><span class="op">)</span></span></code></pre></div>
<p>Dependencies will be installed automatically. We will then need to
load the following packages:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/EBlini/Pupilla" class="external-link">"Pupilla"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://dplyr.tidyverse.org" class="external-link">"dplyr"</a></span><span class="op">)</span> </span>
<span><span class="co"># </span></span>
<span><span class="co"># Attaching package: 'dplyr'</span></span>
<span><span class="co"># The following objects are masked from 'package:stats':</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#     filter, lag</span></span>
<span><span class="co"># The following objects are masked from 'package:base':</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">"ggplot2"</a></span><span class="op">)</span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://tidyr.tidyverse.org" class="external-link">"tidyr"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>dplyr.summarise.inform <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The following steps in this section vary a lot as a function of the
software used for the presentation of the stimuli and your machine.
<code>Pupilla</code> is tested on windows machines, you may thus have
troubles using the utility functions to read all participants
altogether. But this is how you would do in Windows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#set your own working directory first!</span></span>
<span><span class="co">#wd= choose.dir()</span></span>
<span></span>
<span><span class="va">subject</span><span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">51</span> <span class="co">#vector of ids</span></span>
<span><span class="co">#groups- whether ids are smokers or not; </span></span>
<span><span class="co">#this I didn't know beforehand so I have to add manually this var</span></span>
<span><span class="va">group</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"NS"</span>, <span class="st">"S"</span>, <span class="st">"NS"</span>, <span class="st">"NS"</span>, <span class="st">"S"</span>,<span class="st">"S"</span>, <span class="st">"NS"</span>, <span class="st">"S"</span>,</span>
<span>         <span class="st">"S"</span>, <span class="st">"S"</span>, <span class="st">"S"</span>, <span class="st">"S"</span>, <span class="st">"S"</span>, <span class="st">"S"</span>, <span class="st">"NS"</span>, <span class="st">"S"</span>,</span>
<span>         <span class="st">"NS"</span>, <span class="st">"S"</span>, <span class="st">"NS"</span>, <span class="st">"S"</span>, <span class="st">"NS"</span>, <span class="st">"NS"</span>, <span class="st">"S"</span>, <span class="st">"NS"</span>,</span>
<span>         <span class="st">"S"</span>, <span class="st">"NS"</span>, <span class="st">"NS"</span>, <span class="st">"NS"</span>, <span class="st">"NS"</span>, <span class="st">"NS"</span>, <span class="st">"NS"</span>, <span class="st">"S"</span>,</span>
<span>         <span class="st">"S"</span>, <span class="st">"S"</span>, <span class="st">"S"</span>, <span class="st">"NS"</span>, <span class="st">"NS"</span>, <span class="st">"NS"</span>, <span class="st">"NS"</span>, <span class="st">"S"</span>,</span>
<span>         <span class="st">"NS"</span>, <span class="st">"NS"</span>, <span class="st">"NS"</span>, <span class="st">"S"</span>, <span class="st">"S"</span>, <span class="st">"S"</span>, <span class="st">"S"</span>, <span class="st">"S"</span>,</span>
<span>         <span class="st">"S"</span>, <span class="st">"S"</span>, <span class="st">"S"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#read all the files</span></span>
<span><span class="va">data</span><span class="op">=</span> <span class="fu"><a href="../reference/read_TOBII.html">read_TOBII</a></span><span class="op">(</span><span class="va">subject</span>, <span class="va">wd</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#split for eyetracker and behavioral data</span></span>
<span><span class="va">ET</span><span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">ET</span></span>
<span><span class="va">BD</span><span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">BD</span></span></code></pre></div>
<p>As you can see:</p>
<ol style="list-style-type: decimal">
<li>a working directory has been set - change yours!;</li>
<li>there are 51 subjects corresponding to 102 files because by default
OpenSesame splits the eyetracker and behavioral files.</li>
</ol>
<p>So, reading the files should be straightforward. If this utility
function does not work for you, however, just assume that it works by
iterating <code><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">data.table::fread()</a></code> across (eyetracking) files.
Also, please note that by default the first 7 lines are skipped, but
your eyetracker files may need different values!</p>
</div>
<div class="section level2">
<h2 id="prepare-the-data">Prepare the data<a class="anchor" aria-label="anchor" href="#prepare-the-data"></a>
</h2>
<p>I have the bad (?) habit to only record essential info in the
eyetracker file, :)</p>
<p>As a result, very often variables that are only present in the
behavioral file (e.g., response time, condition) must be copied to the
eyetracker file, which has very different dimensions (several lines per
trial, depending on sampling rate). <code>Pupilla</code> has utility
functions to do precisely that. Let’s move in order though.</p>
<p>We start by filling the “Event” column, which is blank except for
when the Event changes:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ET</span><span class="op">$</span><span class="va">Event</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">ET</span><span class="op">$</span><span class="va">Event</span><span class="op">==</span> <span class="st">""</span>, <span class="cn">NA</span>, <span class="va">ET</span><span class="op">$</span><span class="va">Event</span><span class="op">)</span></span>
<span><span class="va">ET</span><span class="op">=</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/fill.html" class="external-link">fill</a></span><span class="op">(</span><span class="va">ET</span>, <span class="va">Event</span>, .direction <span class="op">=</span> <span class="st">"down"</span><span class="op">)</span></span></code></pre></div>
<p>Based on the Event column changing value, we can establish the trial
number (yes, this info is also missing from the eyetracker file!).
<code><a href="../reference/detect_change.html">detect_change()</a></code> simply updates a counter for every instance
in which the parameter “key” appears again in a vector (and only the
first time).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ET</span><span class="op">$</span><span class="va">Subject</span><span class="op">=</span> <span class="va">ET</span><span class="op">$</span><span class="va">p_ID</span></span>
<span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Subject</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Trial<span class="op">=</span> <span class="fu"><a href="../reference/detect_change.html">detect_change</a></span><span class="op">(</span><span class="va">Event</span>, </span>
<span>                              key<span class="op">=</span> <span class="st">"scrambled"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Few initial samples are not assigned to a trial, and shall be
removed:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span><span class="op">[</span><span class="va">ET</span><span class="op">$</span><span class="va">Trial</span><span class="op">&gt;=</span><span class="fl">0</span>,<span class="op">]</span></span></code></pre></div>
<p>We can start now with copying the relevant variables to the ET
dataframe. We start by adding the variable Phase (whether a trial was
labelled as practice, and therefore removed afterwards, or
experimental).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#whether it's practice or experiment</span></span>
<span><span class="va">ET</span><span class="op">$</span><span class="va">Phase</span><span class="op">=</span> <span class="fu"><a href="../reference/copy_variable.html">copy_variable</a></span><span class="op">(</span><span class="st">"Phase"</span><span class="op">)</span></span>
<span><span class="co">#discard practice</span></span>
<span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span><span class="op">[</span><span class="va">ET</span><span class="op">$</span><span class="va">Phase</span><span class="op">==</span> <span class="st">"experiment"</span>,<span class="op">]</span></span>
<span><span class="va">BD</span><span class="op">=</span> <span class="va">BD</span><span class="op">[</span><span class="va">BD</span><span class="op">$</span><span class="va">Phase</span><span class="op">==</span> <span class="st">"experiment"</span>,<span class="op">]</span></span></code></pre></div>
<p>We move on with the variable Trial:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ET</span><span class="op">$</span><span class="va">Trial</span><span class="op">=</span> <span class="fu"><a href="../reference/copy_variable.html">copy_variable</a></span><span class="op">(</span><span class="st">"Trial"</span><span class="op">)</span></span></code></pre></div>
<p>And finally all the variables that make up our experimental
design:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ET</span><span class="op">$</span><span class="va">Condition</span><span class="op">=</span> <span class="fu"><a href="../reference/copy_variable.html">copy_variable</a></span><span class="op">(</span><span class="st">"Condition"</span><span class="op">)</span></span>
<span><span class="co"># ET$Cue= copy_variable("Cue")</span></span>
<span><span class="co"># ET$Accuracy= copy_variable("Accuracy")</span></span>
<span><span class="co"># ET$Image= copy_variable("Image")</span></span>
<span><span class="co"># ET$RT = as.numeric(copy_variable("RT"))</span></span></code></pre></div>
<p>(Of these, only Condition is relevant here, the rest we can skip for
this vignette).</p>
<p>We can finally start handling and preparing the signal about pupil
size!</p>
<p>The TOBII acquired both the left and right eye. So we consolidate the
two in one single variable that represents the average of the two eyes -
but only when both were judged valid by TOBII’s algorithms.</p>
<p>Because the TOBII stores pupil size in mms, we can fetch plausible
values (between 2 and 7 mms) and discard the outlier ones straight
away.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ET</span><span class="op">$</span><span class="va">Pupil</span><span class="op">=</span> <span class="fu"><a href="../reference/consolidate_signal.html">consolidate_signal</a></span><span class="op">(</span><span class="va">ET</span><span class="op">$</span><span class="va">PupilSizeLeft</span>, <span class="va">ET</span><span class="op">$</span><span class="va">PupilSizeRight</span>,</span>
<span>                             <span class="va">ET</span><span class="op">$</span><span class="va">PupilValidityLeft</span>, <span class="va">ET</span><span class="op">$</span><span class="va">PupilValidityRight</span>,</span>
<span>                             strategy <span class="op">=</span> <span class="st">"conservative"</span>,</span>
<span>                             plausible<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then isolate the two experimental stages: scrambled images (our
baseline) vs target images.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span><span class="op">[</span><span class="va">ET</span><span class="op">$</span><span class="va">Event</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"scrambled"</span>, <span class="st">"target"</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<p>We can now realign the timestamps to the first sample of the
scrambled phase. As you can see timestamps are in absolute values, and
their difference is not really constant.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#head(ET$TimeStamp)</span></span>
<span></span>
<span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Subject</span>, <span class="va">Trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Time<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">TimeStamp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#head(ET$Time)</span></span></code></pre></div>
<p>In theory each trial had to last 4500 ms, but one or two for some
reasons missed something and last longer, we shall discard them.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#range(ET$Time)</span></span>
<span></span>
<span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Subject</span>, <span class="va">Trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Anomaly<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Time</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">4500</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># (table(ET$p_ID[ET$Anomaly== 1], </span></span>
<span><span class="co">#       ET$Trial[ET$Anomaly== 1])) #for 1 participant, the trial around the break...</span></span>
<span></span>
<span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span><span class="op">[</span><span class="va">ET</span><span class="op">$</span><span class="va">Anomaly</span><span class="op">==</span> <span class="fl">0</span>,<span class="op">]</span></span></code></pre></div>
<p>Now that everything is clean, we realign Time not to the beginning of
the trial, but to the moment in which the target was presented:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Subject</span>, <span class="va">Trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Time<span class="op">=</span> <span class="va">Time</span> <span class="op">-</span> <span class="va">Time</span><span class="op">[</span><span class="va">Event</span><span class="op">==</span> <span class="st">"target"</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span><span class="op">[</span><span class="va">ET</span><span class="op">$</span><span class="va">Time</span> <span class="op">&gt;</span><span class="op">-</span><span class="fl">1000</span> <span class="op">&amp;</span> <span class="va">ET</span><span class="op">$</span><span class="va">Time</span><span class="op">&lt;</span><span class="fl">3000</span>,<span class="op">]</span></span></code></pre></div>
<p>Finally, this is the moment in which the Group variable is added.
Furthermore, we discard the participants who did not present sufficient
valid trials; this would actually be seen afterwards, but in this
experiment we add another task for which eye movements quality was
important, so that exclusions have been decided based on the results of
both tasks.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">Subject</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">9</span>, <span class="fl">10</span>, <span class="fl">13</span>, <span class="fl">25</span>, <span class="fl">29</span>, <span class="fl">30</span>, <span class="fl">34</span>, <span class="fl">38</span>, <span class="fl">48</span>, <span class="fl">49</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#assign group</span></span>
<span><span class="va">ET</span><span class="op">$</span><span class="va">Group</span><span class="op">=</span> <span class="va">group</span><span class="op">[</span><span class="va">ET</span><span class="op">$</span><span class="va">Subject</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="preprocessing">Preprocessing<a class="anchor" aria-label="anchor" href="#preprocessing"></a>
</h2>
<p>We can finally move to the real thing! The signal must be
<strong>processed</strong> so that the impact of artifacts, blinks, etc.
is reduced. The easiest way to do that in <code>Pupilla</code> would be
to use the <code><a href="../reference/pre_process.html">pre_process()</a></code> function. You may want, however,
to consider whether the specific default parameters are applicable to
your data. For a description of the parameters, see
<code>?pp_options()</code>. You can always change the default parameters
by calling the options globally, other than within the function itself.
E.g.:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#the default parameters:</span></span>
<span><span class="fu"><a href="../reference/pp_options.html">pp_options</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># $thresh</span></span>
<span><span class="co"># [1] 3</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $speed_method</span></span>
<span><span class="co"># [1] "z"</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $extend_by</span></span>
<span><span class="co"># [1] 3</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $island_size</span></span>
<span><span class="co"># [1] 4</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $extend_blink</span></span>
<span><span class="co"># [1] 3</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $overall_thresh</span></span>
<span><span class="co"># [1] 0.4</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $consecutive_thresh</span></span>
<span><span class="co"># NULL</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $spar</span></span>
<span><span class="co"># [1] 0.7</span></span>
<span></span>
<span><span class="co">#this changes the width of the window for smoothing</span></span>
<span><span class="fu"><a href="../reference/pp_options.html">pp_options</a></span><span class="op">(</span><span class="st">"spar"</span><span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> </span></code></pre></div>
<p>Once checked the defaults, preprocessing only requires:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#entire preprocessing</span></span>
<span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Subject</span>, <span class="va">Trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Pupil_pp<span class="op">=</span> <span class="fu"><a href="../reference/pre_process.html">pre_process</a></span><span class="op">(</span><span class="va">Pupil</span>, <span class="va">Time</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>And that’s it! You can <strong>check</strong> the result of the
pipeline visually as follows:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ET</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Subject</span><span class="op">==</span><span class="fl">12</span> <span class="op">&amp;</span> <span class="va">Trial</span><span class="op">==</span> <span class="fl">104</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/check_series.html">check_series</a></span><span class="op">(</span><span class="st">"Pupil"</span>, <span class="st">"Pupil_pp"</span>, <span class="st">"Time"</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/preprocessed_trial-1.png"></p>
<p>Or you can use the function <code><a href="../reference/check_all_series.html">Pupilla::check_all_series()</a></code>
to have all the plots (that is, for all ids and trials) saved as images
in your path.</p>
<p>In the image, the black dots represent the raw, initial data. The red
line depicts instead the reconstructed, preprocessed signal.
<code><a href="../reference/pre_process.html">pre_process()</a></code> simply runs, in order, functions for
deblinking (through a velocity-based criterion), interpolation, and
smoothing through cubic splines. Trials in which data points do not
reach a given quality threshold are set to NA; trials that can be
recovered are, instead, recovered.</p>
<p>So, for those trials in which we couldn’t restore a reliable signal,
we simply discard them!</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#drop</span></span>
<span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Pupil_pp</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Another common step is <strong>downsampling</strong>, we choose bins
of 25 ms:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ET</span><span class="op">$</span><span class="va">Time</span><span class="op">=</span> <span class="fu"><a href="../reference/downsample_time.html">downsample_time</a></span><span class="op">(</span><span class="va">ET</span><span class="op">$</span><span class="va">Time</span>, <span class="fl">25</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#summarise the data for the new binned variable</span></span>
<span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Subject</span>, <span class="va">Group</span>, <span class="va">Condition</span>, <span class="va">Trial</span>, <span class="va">Time</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>Pupil<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">Pupil_pp</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next, I personally prefer to work with <strong>z-scores</strong>
instead of arbitrary units or mms, as to have a standardized measure.
So:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Subject</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Pupil<span class="op">=</span> <span class="op">(</span><span class="va">Pupil</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">Pupil</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">Pupil</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The last, crucial step is the <strong>baseline subtraction</strong>.
In analogy to what done in the paper I simply realign the traces to the
beginning of the target presentation phase, just like what done for
Time. A more extended period would be advisable.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ET</span><span class="op">=</span> <span class="va">ET</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Subject</span>, <span class="va">Trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Pupil<span class="op">=</span> <span class="va">Pupil</span> <span class="op">-</span> <span class="va">Pupil</span><span class="op">[</span><span class="va">Time</span><span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>We are done!</p>
</div>
<div class="section level2">
<h2 id="analysis">Analysis<a class="anchor" aria-label="anchor" href="#analysis"></a>
</h2>
<p>Briefly, the data looks like this:</p>
<p><img src="images/results_pbr-1.png"></p>
<p>We have now different paths for statistical modelling. In the
original paper we choose a cluster-based permutation test. This approach
is often computationally-intensive, though it works very well. Other
approaches involve crossvalidated LMEMs (implemented in the package
<code>Pupilla</code> but shown in another vignette) or <strong>feature
reduction</strong>. Feature reduction is not the norm in pupillometry,
but it is common in other branches of neuroimaging - e.g., fMRI. It
works very well, when data is large, in reducing its dimensions as to
have more manageable variables to work with. In the case of
pupillometry, because the signal is strongly autocorrelated, this is
particularly appealing. <code>Pupilla</code> can summarise the traces
through both PCA and ICA as follows.</p>
<div class="section level3">
<h3 id="pca">PCA<a class="anchor" aria-label="anchor" href="#pca"></a>
</h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span><span class="op">=</span> <span class="va">ET</span><span class="op">[</span><span class="va">ET</span><span class="op">$</span><span class="va">Time</span><span class="op">&gt;</span><span class="fl">0</span>,<span class="op">]</span> <span class="co">#remove the baseline</span></span>
<span><span class="va">dv</span><span class="op">=</span> <span class="st">"Pupil"</span></span>
<span><span class="va">time</span><span class="op">=</span> <span class="st">"Time"</span></span>
<span><span class="va">id</span><span class="op">=</span> <span class="st">"Subject"</span></span>
<span><span class="va">trial</span><span class="op">=</span> <span class="st">"Trial"</span></span>
<span><span class="va">add</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Group"</span>, <span class="st">"Condition"</span><span class="op">)</span> <span class="co">#save to final dataframe</span></span>
<span><span class="va">Ncomp</span><span class="op">=</span> <span class="cn">NULL</span> <span class="co">#defaults to 95% of variance retained</span></span>
<span></span>
<span><span class="va">rf</span> <span class="op">=</span> <span class="fu"><a href="../reference/reduce_PCA.html">reduce_PCA</a></span><span class="op">(</span><span class="va">data</span>,</span>
<span>                <span class="va">dv</span>,</span>
<span>                <span class="va">time</span>,</span>
<span>                <span class="va">id</span>,</span>
<span>                <span class="va">trial</span>,</span>
<span>                Ncomp <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                scaling <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                <span class="va">add</span><span class="op">)</span></span></code></pre></div>
<p>The traces of 40 participants x (about) 200 trials each can be
summarised by very few PCs (you only need 3 variables to account for
&gt;98% of the data!):</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf</span><span class="op">$</span><span class="va">summaryPCA</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span></code></pre></div>
<p>Each PC accounts for a specific share of the variance, and has
distinctive loadings - you can think at them as the weighted
contribution to the PC of each time point, in a way that is very similar
to a cluster, though graded. You can assess the loadings directly or
through a plot conveniently returned by
<code><a href="../reference/plot_loadings.html">plot_loadings()</a></code>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_loadings.html">plot_loadings</a></span><span class="op">(</span><span class="st">"PC1"</span>, <span class="va">rf</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/load_pc1-1.png"></p>
<p>The loadings for the first PC, as expected, resemble very much the
shape of the data. During the trial there was a steady pupil dilation,
which is well captured here in that later timepoints have larger
weights. The sign of the loadings is, instead, arbitrary, and you could
very well multiply them all for -1.</p>
<p>Each component is summarised with only one score per trial! This is
far more manageable for most uses, e.g. to obtain intuitive and easy to
interpret summary scores. Scores can be used directly - e.g., to
correlate with other experimental variables such as questionnaires or
neuroimaging data - or used for a second level analysis (e.g., simple t
tests). In the case of our Group x Condition interaction, we start by
summarising each trial into summary scores, and then scoring the
difference between conditions:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Scores</span><span class="op">=</span> <span class="va">rf</span><span class="op">$</span><span class="va">Scores</span></span>
<span></span>
<span><span class="va">Scores</span><span class="op">=</span> <span class="va">Scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">Group</span>, <span class="va">Condition</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>PC1<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">PC1</span><span class="op">)</span>, PC2<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">PC2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">Group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html" class="external-link">reframe</a></span><span class="op">(</span>PC1<span class="op">=</span> <span class="va">PC1</span><span class="op">[</span><span class="va">Condition</span><span class="op">==</span> <span class="st">"Control"</span><span class="op">]</span><span class="op">-</span><span class="va">PC1</span><span class="op">[</span><span class="va">Condition</span><span class="op">==</span> <span class="st">"Nicotine-related"</span><span class="op">]</span>, </span>
<span>          PC2<span class="op">=</span> <span class="va">PC2</span><span class="op">[</span><span class="va">Condition</span><span class="op">==</span> <span class="st">"Control"</span><span class="op">]</span><span class="op">-</span><span class="va">PC2</span><span class="op">[</span><span class="va">Condition</span><span class="op">==</span> <span class="st">"Nicotine-related"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>For PC1:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#plots of the difference</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">Scores</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">Group</span>,</span>
<span>                   color<span class="op">=</span> <span class="va">Group</span>,</span>
<span>                   y<span class="op">=</span> <span class="va">PC1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge2</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html" class="external-link">t.test</a></span><span class="op">(</span><span class="va">Scores</span><span class="op">$</span><span class="va">PC1</span><span class="op">[</span><span class="va">Scores</span><span class="op">$</span><span class="va">Group</span><span class="op">==</span> <span class="st">"Smokers"</span><span class="op">]</span>,</span>
<span>       <span class="va">Scores</span><span class="op">$</span><span class="va">PC1</span><span class="op">[</span><span class="va">Scores</span><span class="op">$</span><span class="va">Group</span><span class="op">==</span> <span class="st">"Non smokers"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/res_pc1-1.png"></p>
<p>There is a significant interaction between group and condition that
is captured by the first PC!</p>
<p>The second PC is not, instead, significant:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html" class="external-link">t.test</a></span><span class="op">(</span><span class="va">Scores</span><span class="op">$</span><span class="va">PC2</span><span class="op">[</span><span class="va">Scores</span><span class="op">$</span><span class="va">Group</span><span class="op">==</span> <span class="st">"Smokers"</span><span class="op">]</span>,</span>
<span>       <span class="va">Scores</span><span class="op">$</span><span class="va">PC2</span><span class="op">[</span><span class="va">Scores</span><span class="op">$</span><span class="va">Group</span><span class="op">==</span> <span class="st">"Non smokers"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Features after the first ones progressively account for the remaining
variance, and may thus accomodate for subtle differences between
conditions that do not alter necessarily the overall shape of pupillary
dilation. In other words, the next pcs describe some sort of contrast
functions like this one:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_loadings.html">plot_loadings</a></span><span class="op">(</span><span class="st">"PC2"</span>, <span class="va">rf</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/load_pc2-1.png"></p>
</div>
<div class="section level3">
<h3 id="ica">ICA<a class="anchor" aria-label="anchor" href="#ica"></a>
</h3>
<p>Choosing ICA is as simple as that!</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf2</span> <span class="op">=</span> <span class="fu"><a href="../reference/reduce_ICA.html">reduce_ICA</a></span><span class="op">(</span><span class="va">data</span>,</span>
<span>                 <span class="va">dv</span>,</span>
<span>                 <span class="va">time</span>,</span>
<span>                 <span class="va">id</span>,</span>
<span>                 <span class="va">trial</span>,</span>
<span>                 Ncomp <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                 scaling <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                 <span class="va">add</span><span class="op">)</span></span></code></pre></div>
<p><code>Pupilla</code> uses <code><a href="https://rdrr.io/pkg/ica/man/icafast.html" class="external-link">ica::icafast</a></code> for independent
components analysis. The overall explained variance remains that of PCA.
However, the single contribution of components should be weighted
by:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf2</span><span class="op">$</span><span class="va">ICA</span><span class="op">$</span><span class="va">vafs</span></span></code></pre></div>
<p>In other words, do not trust much the title of the loadings plot -
that refers to the PCA model:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_loadings.html">plot_loadings</a></span><span class="op">(</span><span class="st">"IC1"</span>, <span class="va">rf2</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/load_ic1-1.png"></p>
<p>So in this case the first IC and the first PC are very similar, only
the scale changes a bit, as both reflect the overall dilation trend -
again, the sign of the loadings does not really matter (just check the
direction for the interpretation of your data).</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Scores2</span><span class="op">=</span> <span class="va">rf2</span><span class="op">$</span><span class="va">Scores</span></span>
<span></span>
<span><span class="va">Scores2</span><span class="op">=</span> <span class="va">Scores2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">Group</span>, <span class="va">Condition</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>IC1<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">IC1</span><span class="op">)</span>, IC2<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">IC2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">Group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html" class="external-link">reframe</a></span><span class="op">(</span>IC1<span class="op">=</span> <span class="va">IC1</span><span class="op">[</span><span class="va">Condition</span><span class="op">==</span> <span class="st">"Control"</span><span class="op">]</span><span class="op">-</span><span class="va">IC1</span><span class="op">[</span><span class="va">Condition</span><span class="op">==</span> <span class="st">"Nicotine-related"</span><span class="op">]</span>, </span>
<span>          IC2<span class="op">=</span> <span class="va">IC2</span><span class="op">[</span><span class="va">Condition</span><span class="op">==</span> <span class="st">"Control"</span><span class="op">]</span><span class="op">-</span><span class="va">IC2</span><span class="op">[</span><span class="va">Condition</span><span class="op">==</span> <span class="st">"Nicotine-related"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Results are (somehow) similar to PCA:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#plots of the difference</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">Scores2</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">Group</span>,</span>
<span>                   color<span class="op">=</span> <span class="va">Group</span>,</span>
<span>                   y<span class="op">=</span> <span class="va">IC1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge2</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html" class="external-link">t.test</a></span><span class="op">(</span><span class="va">Scores2</span><span class="op">$</span><span class="va">IC1</span><span class="op">[</span><span class="va">Scores</span><span class="op">$</span><span class="va">Group</span><span class="op">==</span> <span class="st">"Smokers"</span><span class="op">]</span>,</span>
<span>       <span class="va">Scores2</span><span class="op">$</span><span class="va">IC1</span><span class="op">[</span><span class="va">Scores</span><span class="op">$</span><span class="va">Group</span><span class="op">==</span> <span class="st">"Non smokers"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/res_ic1-1.png"></p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In this vignette we went through an example of how you could use the
functions in <code>Pupilla</code> for your own data, in areas
encompassing loading, preparing, and preprocessing the data.
Furthermore, a novel approach - and, as such, object of active research
- to analyze the data has been presented. In this approach the signal is
decomposed in few, very manageable scores, the explain efficiently the
(severely autocorrelated) data with only a handful of scores. These
scores can be attributed to differences in pupil size at different time
points, as can be explored visually as the loadings of specific
components. Another advantage is that, in the case of multiple
components presenting significant effects, the weights can be
backprojected as a linear combination of the coefficients and the
loadings (see, for more details, backprojection in my other package, <a href="https://github.com/EBlini/FCnet" class="external-link">FCnet</a>). This approach has
therefore the potential to be very flexible.</p>
<p>This approach will be discussed in more details in the accompanying
paper.</p>
</div>
<div class="section level2">
<h2 id="appendix">Appendix<a class="anchor" aria-label="anchor" href="#appendix"></a>
</h2>
<p>Packages’ versions:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># R version 4.2.3 (2023-03-15 ucrt)</span></span>
<span><span class="co"># Platform: x86_64-w64-mingw32/x64 (64-bit)</span></span>
<span><span class="co"># Running under: Windows 10 x64 (build 19045)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Matrix products: default</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># locale:</span></span>
<span><span class="co"># [1] LC_COLLATE=Italian_Italy.utf8  LC_CTYPE=Italian_Italy.utf8    LC_MONETARY=Italian_Italy.utf8 LC_NUMERIC=C                   LC_TIME=Italian_Italy.utf8    </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># attached base packages:</span></span>
<span><span class="co"># [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># other attached packages:</span></span>
<span><span class="co"># [1] tidyr_1.3.0        ggplot2_3.4.1      dplyr_1.1.0        Pupilla_0.0.0.9000</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># loaded via a namespace (and not attached):</span></span>
<span><span class="co">#  [1] Rcpp_1.0.10         nloptr_2.0.3        pillar_1.8.1        compiler_4.2.3      tools_4.2.3         boot_1.3-28.1       digest_0.6.31       lme4_1.1-32         nlme_3.1-162        evaluate_0.20       lifecycle_1.0.3     tibble_3.2.0        gtable_0.3.1        lattice_0.20-45     pkgconfig_2.0.3     rlang_1.1.3         Matrix_1.5-3        cli_3.6.0           rstudioapi_0.14     patchwork_1.1.2     yaml_2.3.7          xfun_0.39           fastmap_1.1.1       withr_2.5.0         knitr_1.42          generics_0.1.3      vctrs_0.6.0         lmerTest_3.1-3      grid_4.2.3          tidyselect_1.2.0    glue_1.6.2          R6_2.5.1            fansi_1.0.4         rmarkdown_2.20      minqa_1.2.5         purrr_1.0.1         magrittr_2.0.3      settings_0.2.7      scales_1.2.1        htmltools_0.5.4     MASS_7.3-58.2       splines_4.2.3       colorspace_2.1-0    numDeriv_2016.8-1.1 utf8_1.2.3          munsell_0.5.0</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Elvio Blini.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
